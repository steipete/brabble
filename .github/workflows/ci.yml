name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  lint-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install native deps (whisper + portaudio)
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libopenblas-dev portaudio19-dev pkg-config
          git clone --depth 1 https://github.com/ggerganov/whisper.cpp.git /tmp/whisper.cpp
          cmake -S /tmp/whisper.cpp -B /tmp/whisper.cpp/build -DGGML_OPENBLAS=ON -DBUILD_SHARED_LIBS=ON
          cmake --build /tmp/whisper.cpp/build --target whisper --config Release
          sudo mkdir -p /usr/local/lib/whisper /usr/local/include/whisper
          sudo cp /tmp/whisper.cpp/build/src/libwhisper.so* /usr/local/lib/whisper/
          sudo cp /tmp/whisper.cpp/build/ggml/src/libggml*.so* /usr/local/lib/whisper/
          sudo cp -R /tmp/whisper.cpp/include/* /tmp/whisper.cpp/ggml/include/* /usr/local/include/whisper/
          echo "/usr/local/lib/whisper" | sudo tee /etc/ld.so.conf.d/whisper.conf
          sudo ldconfig

      - name: Gofmt (check)
        run: |
          gofmt -w .
          git diff --exit-code

      - name: GolangCI-Lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: v1.64.8
          install-mode: goinstall
          args: --timeout=5m
        env:
          CGO_CFLAGS: -I/usr/local/include/whisper
          CGO_LDFLAGS: -L/usr/local/lib/whisper
          LD_LIBRARY_PATH: /usr/local/lib/whisper

      - name: Go test
        run: go test ./...
        env:
          CGO_CFLAGS: -I/usr/local/include/whisper
          CGO_LDFLAGS: -L/usr/local/lib/whisper
          LD_LIBRARY_PATH: /usr/local/lib/whisper
